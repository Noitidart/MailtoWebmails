    <!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="utf-8">
    <title>PREFERENCES | MailtoWebmails</title>
	<link rel="icon" type="image/png" href="img/icon16.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="firefox, addon, extension, mailto, webmail, pref, preference">
    <meta name="author" content="Noitidart">
    <meta name="description" content="This is the preferences frontend for the MailtoWebmails add-on. From here you can install and uninstall webmail services that will handle mailto links when you click them.">
    <!-- styles -->
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/bootstrap-responsive.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="font/css/fontello.css" rel="stylesheet">
    <link href='css/font-family_droid-sans.css' rel='stylesheet' type='text/css'>
	<!-- scripts -->
	<script>
		const {classes: Cc, interfaces: Ci, utils: Cu} = Components;
		Cu.import('resource://gre/modules/Services.jsm');
		Cu.import('resource://gre/modules/addons/XPIProvider.jsm');
		
		const infoForWebmailHandlers = [
			{
				name: 'AIM Mail',
				uriTemplate: 'http://webmail.aol.com/Mail/ComposeMessage.aspx?to=%s',
				circleSelector: '.skills .css' //this is for me to target the proper row in the dom of the prefs frontend document.getElementById(circleId).parentNode.parentNode is the row element
			},
			{
				name: 'GMail',
				uriTemplate: 'https://mail.google.com/mail/?extsrc=mailto&url=%s',
				circleSelector: '.skills .ai'
			},
			{
				name: 'Outlook Live',
				uriTemplate: 'http://mail.live.com/secure/start?action=compose&to=%s',
				circleSelector: '.skills .ps'
			},
			{
				name: 'Y! Mail',
				uriTemplate: 'https://compose.mail.yahoo.com/?To=%s',
				circleSelector: '.skills .html'
			},
		];
		
		function init() {
			var actToggles = document.querySelectorAll('a.act-toggle');
			Array.prototype.forEach.call(actToggles, function(actTog) {
				actTog.addEventListener('click', toggleToActive, false);
			});
			var stalls = document.querySelectorAll('a.stall-me');
			Array.prototype.forEach.call(stalls, function(stall) {
				stall.addEventListener('click', toggleStall, false);
			});
			
			//start - determine active handler
			var eps = Cc["@mozilla.org/uriloader/external-protocol-service;1"].getService(Ci.nsIExternalProtocolService);
			var handlerInfo = eps.getProtocolHandlerInfo('mailto');
			//console.log('epsHandlerInfo', handlerInfo)
			//console.log('handlerInfo.possibleApplicationHandlers', handlerInfo.possibleApplicationHandlers);
			//end - determine active handler
			
			//start - find installed handlers
			var uriTemplates_of_installedHandlers = [];
			var handlers = handlerInfo.possibleApplicationHandlers.enumerate();
			while (handlers.hasMoreElements()) {
				var handler = handlers.getNext().QueryInterface(Ci.nsIWebHandlerApp);
				uriTemplates_of_installedHandlers.push(handler.uriTemplate);
			}
			//end - find installed handlers

			//start - determine if there is a preferred web app handler
			//note: handlerInfo.preferredAction can be stale. if handlerInfo.alwaysAskBeforeHandling is set to true, than the prerredAction can be internally or whatev its not true it will always ask
			if (handlerInfo.preferredAction == Ci.nsIHandlerInfo.useHelperApp) { //Ci.nsIHandlerInfo has keys: alwaysAsk:1, handleInternally:3, saveToDisk:0, useHelperApp:2, useSystemDefault:4
				//it i shandled internally so it probably is a web app
				if (handlerInfo.preferredApplicationHandler.uriTemplate) { //if app handler is set to local app handler that is default, than preferredApplicationHandler is left at what it was before. can identify if preferredApplicationHandler is stale by testing if `handlerInfo.alwaysAskBeforeHandling == true` OR `handlerInfo.preferredAction != Ci.Ci.nsIHandlerInfo.handleInternally`
					var preferredHandlerUriTemplate = handlerInfo.preferredApplicationHandler.uriTemplate;
				}
			} else {
				//its not handled interntally and for a web app to be a handler for it IT HAS to be set to Ci.nsIHandlerInfo.handleInternally
			}
			//end - determine if there is a preferred web app handler
			
			//start - mark installed handlers as installed in dom AND the active handler as active in dom
			for (var i=0; i<infoForWebmailHandlers.length; i++) {
				var info = infoForWebmailHandlers[i];
				if (uriTemplates_of_installedHandlers.indexOf(info.uriTemplate) > -1) {
					//yes its installed
					var thisRow = document.querySelector(info.circleSelector).parentNode.parentNode;
					//var thisStall = thisRow.querySelector('a.stall-me');
					thisRow.querySelector('.span5').classList.add('stalled');
					/*
					if (handlerInfo.preferredApplicationHandler.uriTemplate == info.uriTemplate) {
						var thisTog = thisRow.querySelector('a.act-toggle');
						thisTog.classList.add('active-me');
					}
					// cant do this way because if it used to be a web app handler (like y mail) and then they changed it to always ask (or a local app handler), the preferredApplicationHandler is left as it what it was last time. so it will be y mail even though it is at always ask (or local app handler)
					*/
				}
			}
			//end - mark installed handlers as installed in dom
		}
		
		function toggleStall(e) {
			//check if active then make it inactive if unisntalled
			
			var thisStall = e.target;
			if (thisStall.nodeName == 'I') {
				thisStall = thisStall.parentNode;
			}
			
			var thisToggle = thisStall.parentNode.querySelector('a.act-toggle');
			if (thisToggle.classList.contains('active-me')) {
				//Services.prompt.alert(Services.wm.getMostRecentWindow('navigator:browser'), 'MailtoWebmails - Exception', 'Cannot uninstall this handler because it is currently set as the active mailto handler');
				var res = Services.prompt.confirm(Services.wm.getMostRecentWindow('navigator:browser'), 'MailtoWebmails - Enable "Always Ask"', 'This handler is currently set as the "Active" handler. If you uninstall this handler it will be made "Inactive" and will enable the "Always Ask" setting. Which means on all future clicks on "mailto:" links, Firefox will ask you which of the installed handlers you want to open the link with.');
				if (res) {
					thisToggle.classList.remove('active-me')
				} else {
					return false;
				}
			}
			thisStall.parentNode.classList.toggle('stalled');
		}
		
		function toggleToActive(e) {
			var thisToggle = e.target;
			if (thisToggle.nodeName == 'I') {
				thisToggle = thisToggle.parentNode;
			}
			
			if (thisToggle.classList.contains('active-me')) {
				//this toggler clicked is active so forget it, exit
				//setting it to inactive. user wants it to always ask
				var res = Services.prompt.confirm(Services.wm.getMostRecentWindow('navigator:browser'), 'MailtoWebmails - Enable "Always Ask"', 'Are you sure want to set the only "Active" handler to "Inactive"? This will enable the "Always Ask" setting. Which means on all future clicks on "mailto:" links, Firefox will ask you which of the installed handlers you want to open the link with.');
				if (res) {
					thisToggle.classList.remove('active-me');
					return true;
				} else {
					return false;
				}
			}
			
			var thisStallParent = thisToggle.parentNode.parentNode;
			if (!thisStallParent.classList.contains('stalled')) {
				Services.prompt.alert(Services.wm.getMostRecentWindow('navigator:browser'), 'MailtoWebmails - Exception', 'Cannot set this handler to active as it is not installed');
				//nevermind comment to right, because sometimes these inactive buttons are clickable, they are expecting it to do something, so do notify them that it cannot set to active as its not installed //not prompting anymore because i made the css so on hover its not a click pointer so its not "clickable" so it should do nothing. so in other words: if the button is not pointer on hover, then on click user should not expect something.
				return false;
			}
			
			var curActive = document.querySelector('a.active-me');
			if (curActive) {
				curActive.classList.remove('active-me');
			}
			thisToggle.classList.add('active-me');
		}
		document.addEventListener('DOMContentLoaded', init, false);
	</script>
    </head>
    <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container"> <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </a> <a class="brand" href="index.html"><img src="img/icon64.png"/></a>
          <ul class="nav nav-collapse pull-right">
			<li><a href="https://github.com/Noitidart/MailtoWebmails/issues/new"><i class="icon-mail"></i> Report A Problem</a></li>
            <li><a href="#" class="active"><i class="icon-doc-text"></i> Preferences</a></li>
          </ul>
          <!-- Everything you want hidden at 940px or less, place within here -->
          <div class="nav-collapse collapse">
            <!-- .nav, .navbar-search, .navbar-form, etc -->
          </div>
        </div>
      </div>
    </div>
    <!--Skills container-->
    <div class="container skills">
      <h2>Add/Remove Handlers</h2>
      <div class="row">
        <div class="span3">
          <div class="css">
            <h3></h3>
          </div>
        </div>
        <div class="span5">
          <h3>AIM Mail<a href="#" class="hire-me act-toggle"><i class="icon-user"></i> </a></h3>
		  <div class="sp5desc">This handles both AOL Mail and AIM Mail</div>
		  <!--
          <div class="expand-bg"> <span class="expand css2"> &nbsp; </span> </div>
		  -->
		  <a href="#" class="hire-me stall-me"><i></i> </a>
        </div>
      </div>
      <div class="row">
        <div class="span3">
          <div class="ai">
            <h3></h3>
          </div>
        </div>
        <div class="span5">
          <h3>Gmail<a href="#" class="hire-me act-toggle"><i class="icon-user"></i> </a></h3>
		  <div class="sp5desc">The GMail handler comes installed by default with Firefox</div>
		  <!--
          <div class="expand-bg"> <span class="expand ai2"> &nbsp; </span> </div>
		  -->
		  <a href="#" class="hire-me stall-me"><i></i> </a>
        </div>
      </div>
      <div class="row">
        <div class="span3">
          <div class="ps">
            <h3></h3>
          </div>
        </div>
        <div class="span5">
          <h3>Outlook Live<a href="#" class="hire-me act-toggle"><i class="icon-user"></i> </a></h3>
		  <div class="sp5desc">Outlook.com is the new Hotmail and Live Mail</div>
		  <!--
		  <h5>Installations <span>10</span></h5>
		  <div class="expand-bg"> <span class="expand ps2"> &nbsp; </span> </div>
		  -->
		  <a href="#" class="hire-me stall-me"><i></i> </a>
        </div>
      </div>
      <div class="row">
        <div class="span3">
          <div class="html">
            <h3></h3>
          </div>
        </div>
        <div class="span5">
		  <h3>Y! Mail<a href="#" class="hire-me act-toggle"><i class="icon-user"></i> </a></h3>
		  <div class="sp5desc">The Yahoo Mail handler comes installed by default with Firefox</div>
		  <!--
          <div class="expand-bg"> <span class="expand html2"> &nbsp; </span> </div>
		  -->
		  <a href="#" class="hire-me stall-me"><i></i> </a>
        </div>
      </div>
    </div>
    <!--END: Skills container-->
    <!-- Footer -->
    <div class="footer">
      <div class="container">
        <p class="pull-left"><a href="https://addons.mozilla.org/en-US/firefox/addon/mailtowebmails/"> <i class="icon-picture"></i> Add-on Homepage</a></p>
        <p class="pull-right"><a href="https://github.com/Noitidart/MailtoWebmails/issues/new?title=Add%20Webservice%20Request:%20TYPE_NAME_OF_WEBMAIL_SERVICE_HERE&body=I%20was%20trying%20to%20install%20a%20webmail%20service%20from%20the%20options%20panel%20of%20MailtoWebesrvices%20but%20the%20one%20I%20was%20looking%20for%20was%20not%20found.%20I%20was%20looking%20for%20TYPE_NAME_OF_WEBMAIL_SERVICE_HERE"> <i class="icon-mail"></i> Didn't find a webmail client you needed? Request it here...</a></p>
      </div>
    </div>
    <!-- Scripts -->
    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
    </body>
    </html>
